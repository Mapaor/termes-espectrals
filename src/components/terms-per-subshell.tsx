import React, { useState } from "react";
import { formatTerm, calculateSubshellDegeneracy, type Term } from "@/lib/spectral-terms";

interface TermsPerSubshellProps {
  perShellTerms: Array<{
    shell: string;
    terms: Term[];
  }>;
  semiOpen?: Array<{ shell: string; e: number }>;
  showDegeneracy?: boolean;
}

export function TermsPerSubshell({ perShellTerms, semiOpen = [], showDegeneracy = false }: TermsPerSubshellProps) {
  const [showModal, setShowModal] = useState(false);
  
  const getSubshellElectrons = (shellName: string) => {
    // Extraiem la lletra de l'orbital (s, p, d, f) del nom complet (2s, 3p, etc.)
    const orbitalType = shellName.replace(/\d+/, ''); // Elimina els n√∫meros
    return semiOpen.find(s => s.shell === orbitalType)?.e || 0;
  };

  return (
    <div className="bg-white rounded-2xl shadow p-4 md:p-6">
      <h2 className="font-semibold mb-3">Termes espectrals per subcapa</h2>
      {perShellTerms.length === 0 ? (
        <div className="text-sm text-slate-500">
          Introdueix una configuraci√≥ electr√≤nica per veure els termes Russell-Saunders 
          generats per cada subcapa parcialment plena.
        </div>
      ) : (
        <div className="space-y-4">
          {perShellTerms.map((item, idx) => {
            // Extreu la subcapa (ex: '3d' de '3d9')
            const subcapa = item.shell.match(/^\d+[spdf]/)?.[0] || item.shell;
            const orbitalType = item.shell.replace(/\d+/, ''); // Mant√© per compatibilitat amb la l√≤gica existent
            const electrons = getSubshellElectrons(item.shell);
            const degeneracy = showDegeneracy ? calculateSubshellDegeneracy(orbitalType, electrons) : null;
            return (
              <div key={idx}>
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-sm text-slate-600">{subcapa}</span>
                  {showDegeneracy && degeneracy && (
                    <span className="text-xs text-purple-600 bg-purple-50 px-2 py-0.5 rounded">
                      ùîá = {degeneracy}
                    </span>
                  )}
                </div>
                <div className="flex flex-wrap gap-2">
                  {item.terms.map((t, i) => (
                    <span
                      key={i}
                      className="px-2.5 py-1 rounded-full bg-violet-50 text-violet-700 border border-violet-200 text-sm"
                    >
                      {formatTerm(t)}
                    </span>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      )}
      
      {perShellTerms.length > 0 && (
        <div className="mt-4">
          <p className="text-xs text-slate-500">
            Obtinguts utilitzant la{" "}
            <button 
              onClick={() => setShowModal(true)}
              className="hover:text-slate-400 transition-all duration-100 ease-in-out underline cursor-pointer"
            >
              taula de refer√®ncia
            </button>
            {""}.
          </p>
        </div>
      )}

      {/* Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-opacity-10 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
          <div className="bg-white rounded-lg shadow-xl max-w-6xl w-full h-[80vh] relative animate-in zoom-in-95 duration-300 ease-out flex flex-col">
            {/* Close button */}
            <button
              onClick={() => setShowModal(false)}
              className="absolute top-4 right-4 text-red-600 hover:text-red-800 text-2xl font-bold z-10 transition-colors duration-150"
            >
              ‚úï
            </button>
            
            {/* Modal header */}
            <div className="p-6 pb-4 border-b border-slate-200">
              <h3 className="text-xl font-semibold text-slate-800">Taula de termes espectrals per subcapes</h3>
            </div>
            
            {/* Modal content - scrollable */}
            <div className="flex-1 overflow-y-auto p-6">
              <div className="overflow-x-auto">
                <table className="w-full border-collapse border border-slate-300 text-sm">
                  <thead>
                    <tr className="bg-slate-50">
                      <th className="border border-slate-300 px-3 py-2 text-left font-semibold text-slate-700">
                        Configuraci√≥ Electr√≤nica
                      </th>
                      <th className="border border-slate-300 px-3 py-2 text-center font-semibold text-slate-700">
                        Termes Singlet (¬πL)
                      </th>
                      <th className="border border-slate-300 px-3 py-2 text-center font-semibold text-slate-700">
                        Termes Doublet (¬≤L)
                      </th>
                      <th className="border border-slate-300 px-3 py-2 text-center font-semibold text-slate-700">
                        Termes Triplet (¬≥L)
                      </th>
                      <th className="border border-slate-300 px-2 py-2 text-center font-semibold text-slate-700">
                        Termes Quartet (‚Å¥L)
                      </th>
                      <th className="border border-slate-300 px-2 py-2 text-center font-semibold text-slate-700">
                        Termes Quintet (‚ÅµL)
                      </th>
                      <th className="border border-slate-300 px-2 py-2 text-center font-semibold text-slate-700">
                        Termes Sextet (‚Å∂L)
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr className="hover:bg-slate-25">
                      <td className="border border-slate-300 px-3 py-2 font-mono text-slate-700">ns¬π</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬≤S</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                    </tr>
                    <tr className="hover:bg-slate-25">
                      <td className="border border-slate-300 px-3 py-2 font-mono text-slate-700">ns¬≤</td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬πS</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                    </tr>
                    <tr className="hover:bg-slate-25">
                      <td className="border border-slate-300 px-3 py-2 font-mono text-slate-700">np¬π, np‚Åµ</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬≤P</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                    </tr>
                    <tr className="hover:bg-slate-25">
                      <td className="border border-slate-300 px-3 py-2 font-mono text-slate-700">np¬≤, np‚Å¥</td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬πS, ¬πD</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬≥P</td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                    </tr>
                    <tr className="hover:bg-slate-25">
                      <td className="border border-slate-300 px-3 py-2 font-mono text-slate-700">np¬≥</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬≤P, ¬≤D</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center font-mono">‚Å¥S</td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                    </tr>
                    <tr className="hover:bg-slate-25">
                      <td className="border border-slate-300 px-3 py-2 font-mono text-slate-700">np‚Å∂</td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬πS</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                    </tr>
                    <tr className="hover:bg-slate-25">
                      <td className="border border-slate-300 px-3 py-2 font-mono text-slate-700">nd¬π, nd‚Åπ</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬≤D</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                    </tr>
                    <tr className="hover:bg-slate-25">
                      <td className="border border-slate-300 px-3 py-2 font-mono text-slate-700">nd¬≤, nd‚Å∏</td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬πS, ¬πD, ¬πG</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬≥P, ¬≥F</td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                    </tr>
                    <tr className="hover:bg-slate-25">
                      <td className="border border-slate-300 px-3 py-2 font-mono text-slate-700">nd¬≥, nd‚Å∑</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬≤P, ¬≤D, ¬≤F, ¬≤G, ¬≤H</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center font-mono">‚Å¥P, ‚Å¥F</td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                    </tr>
                    <tr className="hover:bg-slate-25">
                      <td className="border border-slate-300 px-3 py-2 font-mono text-slate-700">nd‚Å¥, nd‚Å∂</td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬πS, ¬πD, ¬πF, ¬πG, ¬πI</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬≥P, ¬≥D, ¬≥F, ¬≥G, ¬≥H</td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center font-mono">‚ÅµD</td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                    </tr>
                    <tr className="hover:bg-slate-25">
                      <td className="border border-slate-300 px-3 py-2 font-mono text-slate-700">nd‚Åµ</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬≤S, ¬≤P, ¬≤D, ¬≤F, ¬≤G, ¬≤H, ¬≤I</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center font-mono">‚Å¥P, ‚Å¥D, ‚Å¥F, ‚Å¥G</td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center font-mono">‚Å∂S</td>
                    </tr>
                    <tr className="hover:bg-slate-25">
                      <td className="border border-slate-300 px-3 py-2 font-mono text-slate-700">nd¬π‚Å∞</td>
                      <td className="border border-slate-300 px-3 py-2 text-center font-mono">¬πS</td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-3 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                      <td className="border border-slate-300 px-2 py-2 text-center text-slate-400"></td>
                    </tr>
                  </tbody>
                  <caption className="text-slate-600 text-xs py-2 mb-1 caption-bottom text-center italic">
                  Taula: Termes espectrals per subcapa compatibles amb el principi d&apos;exclusi√≥ de Pauli.
                    
                    
                  </caption>
                </table>
              </div>
              
              {/* Reference citation */}
              <div className="mt-2 pt-2">
                <p className="text-sm text-slate-500 text-center">
                  La original es troba a <a href="https://www.if.ufrj.br/~ginette/2017-FIW476/livros%20e%20artigos/Physics_of_atoms_and_molecules_Bransden_Joachain.pdf#page=353" className="hover:text-slate-400 transition-all duration-100 ease-in-out underline cursor-pointer">
                  Physics of Atoms and Molecules (Bransden, 1990)</a>, p√†g. 345.
                </p>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
